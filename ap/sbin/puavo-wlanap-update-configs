#!/bin/sh

set -u

. /etc/puavo-wlanap/config

[ -f "/etc/puavo/wlan/ssid" ] && while IFS=':' read auth ssid psk
do
    hostap_auth=$auth
    hostap_ssid=$ssid
    hostap_psk=$psk
done < /etc/puavo/wlan/ssid

if [ -f "/etc/puavo/wlan/channel" ]; then
    read hostap_channel < /etc/puavo/wlan/channel
fi

if [ -z "$hostap_channel" ]
then
    logger -t puavo-wlanap -s -p user.err "hostap_channel is not set"
    exit 1
fi

if [ -z "$hostap_ssid" ]
then
    logger -t puavo-wlanap -s -p user.err "hostap_ssid is not set"
    exit 2
fi

if [ -z "$hostap_auth" ]
then
    logger -t puavo-wlanap -s -p user.err "wlan type is not set"
    exit 3
fi

if [ "$hostap_auth" = "psk" ]
then
    if [ ${#hostap_psk} -lt 8 -o ${#hostap_psk} -gt 63 ]
    then
	logger -t puavo-wlanap -s -p user.err "hostap_psk must be 8-63 characters long"
	exit 4
    fi
fi

mkdir -p /var/run/puavo-wlanap

sed -e "s/#{hostap_interface}/$hostap_interface/g" \
    -e "s/#{hostap_ssid}/$hostap_ssid/g" \
    -e "s/#{hostap_psk}/$hostap_psk/g" \
    /etc/puavo-wlanap/${hostap_auth}_hostapd.conf.template > /var/run/puavo-wlanap/hostapd.conf

sed -e "s/#{hostap_interface}/$hostap_interface/g" \
    /etc/puavo-wlanap/vtund.conf.template > /var/run/puavo-wlanap/vtund.conf
