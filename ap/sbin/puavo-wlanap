#!/bin/bash

set -eu

on_exit()
{
    local -r exitval=$?

    set +e

    dhclient -r "br.$hostap_interface"

    kill $(cat "/var/run/puavo-wlanap/dhclient.pid")
    kill $(cat "/var/run/puavo-wlanap/hostapd.pid")
    kill $(cat "/var/run/puavo-wlanap/vtund.pid")
    kill $(cat "/var/run/puavo-wlanap/sleep.pid")

    rm -rf "/var/run/puavo-wlanap"

    exit $exitval
}

if [ $# -gt 1 ]; then
    echo "puavo-wlanap: error: too many arguments" >&2
    echo "Usage: puavo-wlanap [--daemon]" >&2
    exit 1
fi

if [ $# -eq 1 ]; then
    if [ "$1" = "--daemon" ]; then
        daemon --noconfig --stderr='daemon.info' --name='puavo-wlanap' -- puavo-wlanap
        exit 0
    fi
    echo "puavo-wlanap: error: unexpected argument '$1'" >&2
    echo "Usage: puavo-wlanap [--daemon]" >&2
    exit 1
fi

. /etc/puavo-wlanap/config

trap on_exit EXIT

mkdir -p "/var/run/puavo-wlanap"

puavo-wlanap-update-configs

vtund -n -f /var/run/puavo-wlanap/vtund.conf puavo-wlanap "$vtun_gateway" &
echo "$!" >"/var/run/puavo-wlanap/vtund.pid"

while true; do
    sleep 300 &
    echo "$!" >"/var/run/puavo-wlanap/sleep.pid"
    wait $(cat "/var/run/puavo-wlanap/sleep.pid")

    puavo-wlanap-report-status || true
done
