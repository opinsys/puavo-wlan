#!/bin/sh

set -eu

if [ $# -eq 1 ]; then
    if [ "$1" = "--daemon" ]; then
        daemon --noconfig --name='puavo-wlanap' -- puavo-wlanap
        exit 0
    fi
    echo "puavo-wlanap: error: unexpected argument '$1'" >&2
    echo "Usage: puavo-wlanap [--daemon]" >&2
    exit 1
fi

exit_requested=0

postponed_graceful_exit()
{
    exit_requested=1
}

stop_process()
{
    local pidfile=$1
    [ -f $pidfile ] || return
    read hostapd_pid <$pidfile
    kill $hostapd_pid
    wait $hostapd_pid
    rm -f $pidfile
}

graceful_exit()
{
    [ $sleeppid ] && kill $sleeppid

    dhclient -r br.$hostap_interface
    stop_process /var/run/puavo-wlanap/dhclient.pid
    stop_process /var/run/puavo-wlanap/hostapd.pid
    stop_process /var/run/vtund.puavo-wlanap-$vtun_gateway.pid

    exit 0
}

. /etc/puavo-wlanap/config

puavo-wlanap-update-configs
exitval=$?

if [ $exitval -eq 1 ]; then
    # puavo-wlanap-update-configs exits with 1 if hostap_channel is
    # not set. That is fine, the user did not want puavo-wlanap to
    # run.
    exit 0
fi

if [ $exitval -gt 1 ]; then
    exit $exitval
fi

trap postponed_graceful_exit INT TERM HUP

vtund -f /var/run/puavo-wlanap/vtund.conf puavo-wlanap $vtun_gateway
if [ $? -ne 0 ]; then
    echo "error: failed to start vtun" | logger -t puavo-wlanap -s -p user.err
    exit 1
fi

trap graceful_exit INT TERM HUP

if [ $exit_requested -ne 0 ]; then
    graceful_exit
fi

mainloop()
{
    while true; do
	sleep 300 & sleeppid=$!
	wait
	puavo-wlanap-report-status
    done
}

mainloop
