#!/bin/bash

set -eubm

on_exit()
{
    local -r exitval=$?

    set +eu

    ## Ignore all terminating signals because we are already
    ## exiting. Ignoring ensures that this function is not interrupted.
    trap '' EXIT HUP INT QUIT ABRT ALRT TERM USR1 USR2

    for net in "${PUAVO_WLANAP_NETS[@]}"; do
        IFS=':' read _ ssid _ <<<"${net}"
        dhclient -r "${ssid}" -pf "${PUAVO_WLANAP_RUNDIR}/${ssid}_dhclient.pid"
    done

    ## Kill children.
    pkill -TERM -P $$

    rm -rf "${PUAVO_WLANAP_RUNDIR}"

    exit $exitval
}

get_bssid()
{
    local -r iface=$1
    local -r mac_head=$(ifconfig "${iface}" | head -n1 | sed -rn 's/.*HWaddr (([0-9a-f][0-9a-f]:){5})([0-9a-f])[0-9a-f]\s*$/\1\3/p')
    local mac_tail=0
    local mac="${mac_head}${mac_tail}"

    [ -n "${mac}" ] || return 1

    while [ "${mac_tail}" != "10" ]; do
        ifconfig "${iface}" hw ether "${mac}" >/dev/null 2>/dev/null && {
            echo "${mac}"
            return 0
        }
        mac_tail=$(echo "obase=16; ${mac_tail} + 1" | bc)
        mac="${mac_head}${mac_tail}"
    done
    return 1
}

## Find suitable WLAN interfaces and print their names to stdout, one
## per line.
find_ifaces()
{
    local -r hw_mode=$1
    local path
    local iface
    local driver

    for path in /sys/class/net/*; do
        iface=$(basename "${path}")

        ## We are only interested in wlan interfaces.
        grep -q '^DEVTYPE=wlan$' "${path}/uevent" || continue

        ## Find its driver.
        driver=$(sed -rn 's/^DRIVER=(.*)$/\1/p' "${path}/device/uevent")
        [ -n "${driver}" ] || {
            puavo_wlanap_log "driver not found for ${iface}, ignoring"
            continue
        }

        ## Ignore if the driver is not whitelisted.
        grep -q "${driver}" "${PUAVO_WLANAP_DATADIR}/supported_drivers" \
            || continue

        ## Ignore if it is of wrong type, i.e. the iwconfig output does
        ## not include the hw_mode char.
        iwconfig "${iface}" | sed -rn '1 s/^.*IEEE 802.11([a-z]+).*/\1/p' \
            | grep -q "${hw_mode}" || continue

        ## All tests passed, the current interface meets our
        ## requirements. Print its interface name.
        echo "${iface}"
    done
}

write_hostapd_conf()
{
    local ssid_count
    local bssid

    for iface in "${PUAVO_WLANAP_IFACES[@]}"; do
        ssid_count=0
        bssid=$(get_bssid "${iface}")

        [ -n "${bssid}" ] || {
            puavo_wlanap_log "failed to find the first address in the block"
            return 1
        }

        # Write interface-specific hostapd configs.
        sed -e "s|#{PUAVO_WLANAP_IFACE}|${iface}|g" \
            -e "s|#{PUAVO_WLANAP_BSSID}|${bssid}|g" \
            -e "s|#{PUAVO_WLANAP_RUNDIR}|${PUAVO_WLANAP_RUNDIR}|g" \
            "${PUAVO_WLANAP_DATADIR}/hostapd.conf" \
            >"${PUAVO_WLANAP_RUNDIR}/${iface}_hostapd.conf"

        for net in "${PUAVO_WLANAP_NETS[@]}"; do
            IFS=':' read auth ssid psk <<<"${net}"

            # Append SSID-specific hostapd configs.
            cat "${PUAVO_WLANAP_DATADIR}/${auth}_hostapd.conf" \
                >>"${PUAVO_WLANAP_RUNDIR}/${iface}_hostapd.conf"
            sed -i \
                -e "s|#{PUAVO_WLANAP_BSS}|${iface}_${ssid_count}|g" \
                -e "s|#{PUAVO_WLANAP_SSID}|${ssid}|g" \
                -e "s|#{PUAVO_WLANAP_PSK}|${psk}|g" \
                "${PUAVO_WLANAP_RUNDIR}/${iface}_hostapd.conf"
            ssid_count=$((ssid_count + 1))
        done
    done
}

write_vtund_conf()
{
    for net in "${PUAVO_WLANAP_NETS[@]}"; do
        IFS=':' read auth ssid psk <<<"${net}"

        # Write SSID-specific vtund configs.
        sed -e "s|#{PUAVO_WLANAP_LIBDIR}|${PUAVO_WLANAP_LIBDIR}|g" \
            -e "s|#{PUAVO_WLANAP_SSID}|${ssid}|g" \
            -e "s|#{PUAVO_WLANAP_RUNDIR}|${PUAVO_WLANAP_RUNDIR}|g" \
            "${PUAVO_WLANAP_DATADIR}/vtund.conf" \
            >"${PUAVO_WLANAP_RUNDIR}/${ssid}_vtund.conf"
    done
}

parse_args()
{
    PUAVO_WLANAP_ARGS_DAEMON=0

    if [ $# -eq 1 ]; then
        if [ "$1" = "--daemon" ]; then
            PUAVO_WLANAP_ARGS_DAEMON=1
            return 0
        fi
        puavo_wlanap_log "unexpected argument '$1'"
        echo "Usage: $(basename $0) [--daemon]" >&2
        return 1
    elif [ $# -gt 2 ]; then
        puavo_wlanap_log "too many arguments"
        echo "Usage: $(basename $0) [--daemon]" >&2
        return 1
    fi
}

report_status()
{
    local -r output=$(hostapd_cli -p "${PUAVO_WLANAP_RUNDIR}/hostapd" all_sta)
    local -r devices=$(echo -n "${output}" | sed -n 's/^dot11RSNAStatsSTAAddress=//p' | tr '\n' ',')

    puavo_wlanap_report <<EOF
wlan_event:hotspot_state
connected_devices:[${devices}]
EOF
}

# We don't know yet where our data, libs and configs have been
# installed, but we do know that the following script knows it and we do
# know where the following script is (its in PATH!).
. puavo-wlanap-env

. "${PUAVO_WLANAP_DATADIR}/config"

# The user might have deleted the configuration file, that's ok.
[ -r "${PUAVO_WLANAP_CONFDIR}/config" ] && . "${PUAVO_WLANAP_CONFDIR}/config"

. "${PUAVO_WLANAP_LIBDIR}/common.sh"

parse_args "$@"

if [ "${PUAVO_WLANAP_ARGS_DAEMON}" -ne 0 ]; then
    daemon --noconfig --stderr='daemon.info' --name='puavo-wlanap' -- puavo-wlanap
    exit 0
fi

trap on_exit EXIT

mkdir -p "${PUAVO_WLANAP_RUNDIR}"

readarray -n0 -t PUAVO_WLANAP_NETS </etc/puavo/wlan/ssid
if [ ${#PUAVO_WLANAP_NETS[@]} -eq 0 ]; then
    puavo_wlanap_log "no networks defined"
    exit 1
fi

for net in "${PUAVO_WLANAP_NETS[@]}"; do
    IFS=':' read auth ssid psk <<<"${net}"
    case "${auth}" in
        open)
            if [ -n "${psk}" ]; then
                puavo_wlanap_log "auth type is 'open', but psk was defined"
            fi
            ;;
        psk)
            if [ "${#psk}" -lt 8 -o "${#psk}" -gt 63 ]; then
                puavo_wlanap_log "psk must be 8-63 characters long"
                exit 1
            fi
            ;;
        *)
            puavo_wlanap_log "unknown auth type '${auth}'"
            exit 1
            ;;
    esac
done

write_hostapd_conf

write_vtund_conf

for net in "${PUAVO_WLANAP_NETS[@]}"; do
    IFS=':' read _ ssid _ <<<"${net}"
    vtund -n -f "${PUAVO_WLANAP_RUNDIR}/${ssid}_vtund.conf" \
        -P "${PUAVO_WLANAP_GWPORT}" \
        "${ssid}" "${PUAVO_WLANAP_GWADDR}" &
done

sleep 8 & wait $!
for iface in "${PUAVO_WLANAP_IFACES[@]}"; do
    hostapd -P "${PUAVO_WLANAP_RUNDIR}/${iface}_hostapd.pid" \
        "${PUAVO_WLANAP_RUNDIR}/${iface}_hostapd.conf" &
done

while true; do
    sleep 3 & wait $!

    report_status || true
done
