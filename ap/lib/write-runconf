#!/bin/sh

set -eu

. "${PUAVO_WLANAP_LIBDIR}/common.sh"

[ -f "/etc/puavo/wlan/ssid" ] && while IFS=':' read auth ssid psk; do
    PUAVO_WLANAP_AUTH=$auth
    PUAVO_WLANAP_SSID=$ssid
    PUAVO_WLANAP_PSK=$psk
done </etc/puavo/wlan/ssid

if [ -f "/etc/puavo/wlan/channel" ]; then
    read PUAVO_WLANAP_CHANNEL </etc/puavo/wlan/channel
fi

[ -n "${PUAVO_WLANAP_CHANNEL}" ] || puavo_wlanap_fail "channel is not set"

[ -n "${PUAVO_WLANAP_SSID}" ] || puavo_wlanap_fail "ssid is not set"

[ -n "${PUAVO_WLANAP_AUTH}" ] || puavo_wlanap_fail "auth is not set"

if [ "${PUAVO_WLANAP_AUTH}" = "psk" ]; then
    if [ ${#PUAVO_WLANAP_PSK} -lt 8 -o ${#PUAVO_WLANAP_PSK} -gt 63 ]; then
        puavo_wlanap_fail "psk must be 8-63 characters long"
    fi
fi

sed -e "s/#{PUAVO_WLANAP_IFACE}/${PUAVO_WLANAP_IFACE}/g" \
    -e "s/#{PUAVO_WLANAP_SSID}/${PUAVO_WLANAP_SSID}/g" \
    -e "s/#{PUAVO_WLANAP_PSK}/${PUAVO_WLANAP_PSK}/g" \
    "${PUAVO_WLANAP_DATADIR}/${PUAVO_WLANAP_AUTH}_hostapd.conf" \
    >"${PUAVO_WLANAP_RUNDIR}/hostapd.conf"

sed -e "s/#{PUAVO_WLANAP_LIBDIR}/${PUAVO_WLANAP_LIBDIR}/g" \
    -e "s/#{PUAVO_WLANAP_GWPORT}/${PUAVO_WLANAP_GWPORT}/g" \
    -e "s/#{PUAVO_WLANAP_IFACE}/${PUAVO_WLANAP_IFACE}/g" \
    -e "s/#{PUAVO_WLANAP_RUNDIR}/${PUAVO_WLANAP_RUNDIR}/g" \
    "${PUAVO_WLANAP_DATADIR}/vtund.conf" \
    >"${PUAVO_WLANAP_RUNDIR}/vtund.conf
