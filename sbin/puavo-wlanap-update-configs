#!/bin/sh

set -u

. /etc/puavo-wlanap/config

while read line
do
    case line in
    	openwlan)
    	    hostap_auth="open"
    	    ;;
    	eapwlan)
    	    hostap_auth="eap"
    	    ;;
    	pskwlan)
    	    hostap_auth="psk"
    	    ;;
    	*)
	    if [ -z $hostap_auth ]
	    then
		hostap_auth=$(echo $line | sed -n 's/^wlantype:\(.*\)$/\1/p')
	    fi

	    if [ -z $hostap_channel ]
	    then
		hostap_channel=$(echo $line | sed -n 's/^wlanch:\(.*\)$/\1/p')
	    fi

	    if [ -z $wlanif ]
	    then
		wlanif=$(echo $line | sed -n 's/^wlanif:\(.*\)$/\1/p')
	    fi

	    if [ -z $hostap_ssid ]
	    then
		hostap_ssid=$(echo $line | sed -n 's/^ssid:\(.*\)$/\1/p')
	    fi

	    if [ -z $hostap_psk ]
	    then
		hostap_psk=$(echo $line | sed -n 's/^psk:\(.*\)$/\1/p')
	    fi

    	    ;;
    esac
done < /etc/puavo/hosttags

if [ -z "$hostap_channel" ]
then
    logger -p user.info "hostap_channel is not set, exiting"
    exit 1
fi

if [ -z "$hostap_ssid" ]
then
    logger -p user.err "hostap_ssid is not set, aborting"
    exit 2
fi

if [ -z "$hostap_auth" ]
then
    logger -p user.err "wlan type is not set, aborting"
    exit 3
fi

if [ "$hostap_auth" = "psk" ]
then
    if [ ${#hostap_psk} -lt 8 -o ${#hostap_psk} -gt 63 ]
    then
	logger -p user.err "hostap_psk must be 8-63 characters long, aborting"
	exit 4
    fi
fi

mkdir -p /var/tmp/puavo-wlanap

sed -e "s/#{wlanif}/$wlanif/g" \
    -e "s/#{hostap_ssid}/$hostap_ssid/g" \
    -e "s/#{hostap_psk}/$hostap_psk/g" \
    -e "s/#{eap_auth_server_addr}/$eap_auth_server_addr/g" \
    -e "s/#{eap_auth_server_port}/$eap_auth_server_port/g" \
    -e "s/#{eap_auth_server_shared_secret}/$eap_auth_server_shared_secret/g" \
    -e "s/#{eap_acct_server_addr}/$eap_acct_server_addr/g" \
    -e "s/#{eap_acct_server_port}/$eap_acct_server_port/g" \
    -e "s/#{eap_acct_server_shared_secret}/$eap_acct_server_shared_secret/g" \
    /etc/puavo-wlanap/${hostap_auth}_hostapd.conf.template > /var/tmp/puavo-wlanap/hostapd.conf

sed -e "s/#{wlanif}/$wlanif/g" \
    /etc/puavo-wlanap/vtund.conf.template > /var/tmp/puavo-wlanap/vtund.conf
