#!/bin/sh

set -u

. /etc/puavo-wlanap/config

while read line
do
    case line in
    	openwlan)
    	    wlantype="open"
    	    ;;
    	eapwlan)
    	    wlantype="eap"
    	    ;;
    	pskwlan)
    	    wlantype="psk"
    	    ;;
    	*)
	    if [ -z $wlantype ]
	    then
		wlantype=$(echo $line | sed -n 's/^wlantype:\(.*\)$/\1/p')
	    fi

	    if [ -z $wlanch ]
	    then
		wlanch=$(echo $line | sed -n 's/^wlanch:\(.*\)$/\1/p')
	    fi

	    if [ -z $wlanif ]
	    then
		wlanif=$(echo $line | sed -n 's/^wlanif:\(.*\)$/\1/p')
	    fi

	    if [ -z $ssid ]
	    then
		ssid=$(echo $line | sed -n 's/^ssid:\(.*\)$/\1/p')
	    fi

	    if [ -z $password ]
	    then
		password=$(echo $line | sed -n 's/^psk:\(.*\)$/\1/p')
	    fi

    	    ;;
    esac
done < $puavoroot/hosttags

if [ -z "$wlanch" ]
then
    logger -p user.info "wlan channel is not set, exiting"
    exit 1
fi

if [ -z "$ssid" ]
then
    logger -p user.err "wlan ssid is not set, aborting"
    exit 2
fi

if [ -z "$wlantype" ]
then
    logger -p user.err "wlan type is not set, aborting"
    exit 3
fi

if [ "$wlantype" = "psk" ]
then
    if [ ${#password} -lt 8 -o ${#password} -gt 63 ]
    then
	logger -p user.err "password must be 8-63 characters long, aborting"
	exit 4
    fi
fi

mkdir -p /var/tmp/puavo-wlanap

sed -e "s/#{wlanif}/$wlanif/g" \
    -e "s/#{ssid}/$ssid/g" \
    -e "s/#{password}/$password/g" \
    -e "s/#{eap_auth_server_addr}/$eap_auth_server_addr/g" \
    -e "s/#{eap_auth_server_port}/$eap_auth_server_port/g" \
    -e "s/#{eap_auth_server_shared_secret}/$eap_auth_server_shared_secret/g" \
    -e "s/#{eap_acct_server_addr}/$eap_acct_server_addr/g" \
    -e "s/#{eap_acct_server_port}/$eap_acct_server_port/g" \
    -e "s/#{eap_acct_server_shared_secret}/$eap_acct_server_shared_secret/g" \
    /etc/puavo-wlanap/${wlantype}_hostapd.conf.template > /var/tmp/puavo-wlanap/hostapd.conf

sed -e "s/#{wlanif}/$wlanif/g" \
    /etc/puavo-wlanap/vtund.conf.template > /var/tmp/puavo-wlanap/vtund.conf
