#!/bin/sh

. /etc/puavo-wlanap.conf

puavo-wlanap-configure

on_exit()
{
    kill $(cat /var/tmp/puavo-wlanap/hostapd.pid)
    rm /var/tmp/puavo-wlanap/hostapd.pid
    killall vtund
    exit $?
}

mainloop()
{
    while true
    do
	sleep 300
	puavo-wlanap-send-status
    done
}

trap on_exit TERM INT HUP

vtund -n -f /var/tmp/puavo-wlanap/vtund.conf wlan $server_ip&
hostapd -P /var/tmp/puavo-wlanap/hostapd.pid /var/tmp/puavo-wlanap/hostapd.conf&

if [ $? -ne 0 ]
then
    echo "error: failed to initialize tunnels" >&2
    exit 1
fi

mainloop
